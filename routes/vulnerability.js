var express=require('express');
var router=express.Router();
var mp=require('../module/exploit');
var ctt=require("../routes/check_token_time");

var mongoose = require('mongoose');
var tk;

function get_vulnerability(name,email,token,callback) {
    if (name.length !== 0) {
        ctt(email,token,function(found){
            tk=found.Token;
            if(found.Response==="Updated"){
                mp.find({"Name":name},function(err,found){
                    var length=found.length;
                    if(length!=0){
                        found.forEach(function(password){
                            callback({"Response":"Success","User":[{"email":email,"token":tk}],"Data":found});
                        });
                    }else{
                        callback({"Response":"Not Found","User":[{"email":email,"token":tk}]});
                    }
                });
            }else if(found.Response==="Error Occurs"){
                callback({"Response":"Something went wrong!"});
            }else if(found.Response==="Token Invalid"){
                callback({"Response":"Token Invalid"});
            }else if(found.Response==="Email Invalid"){
                callback({"Response":"Email Invalid"});
            }
        });
    }else{
        callback({"Response":"Please fill in the ssid and passsword"});
    }
}


router.post('/get_vulnerability',function(req,res){
    var name=req.body.name;
    var token=req.body.token;
    var email=req.body.email;
    get_vulnerability(name,email,token,function(found){
        console.log(found);
        res.json(found);
    });
});

module.exports = router;